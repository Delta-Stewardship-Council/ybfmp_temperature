---
title: "setup"
author: "Pascale Goertler"
date: '2022-06-24'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)

```

## f_get

This is an R Markdown document detailing the data and scripts within the Yolo Bypass Fish Monitoring Program (YBFMP) water temperature repo. 

Within the data_clean folder, the raw (years combined) temperature logger data from the Yolo Bypass rotary screw trap and Sherwood Harbor locations is rstr_98_18.csv and shw_98_20.csv, respectively. Those data are made into daily QC'ed datasets - rstr_98_18_daily_logger.csv and SHWharbor_98_20_daily_logger.csv.

The f_get functions bring in the raw data from the data_raw folder and relevant EDI publications. The clean_ data is the final daily water temperature data for each location.

```{r data}
lis <- read.csv("data_clean/clean_lis.csv") # lisbon weir
rv <- read.csv("data_clean/clean_rv.csv") # rio vista
shw <- read.csv("data_clean/clean_shw.csv") # sherwood harbor
yb <- read.csv("data_clean/clean_yb.csv") # yolo bypass

# integrated data published on EDI ()
colnames(rv)[2] <- "date"

rv$region <- "river_downstream"
shw$region <- "river_upstream"
yb$region <- "floodplain_bypass"

integrated_data <- rbind(rv, shw, yb)
integrated_data <- integrated_data[,-1] # group is not needed
integrated_data$date <- as.Date(integrated_data$date)

```

## f_make

The f_make functions impute missing dates of water temperature data when consecutive missing days are less than or equal to one week (seven days). Otherwise a linear model is used to estimate water temperature on days when data gaps are larger than seven days.

For the Yolo Bypass, the water temperature collected during fish sampling is incorporated into the water temperature time series before imputation. 

```{r f_make, echo=FALSE}

integrated_data %>%
  group_by(region, method) %>%
  summarise_each(funs(n = sum(!is.na(.))))

```

## clean data

Each clean_ data set includes columns date, mean, max, min, sd, cv, n, method, category, length and site. 

```{r f_clean, echo=FALSE}
# the combined data set published on EDI includes a "region" variable because sites of water temperature collection vary for some locations (yb and rv)

unique(integrated_data$site) # see Yolo Bypass Fish Monitoring Program data for site locations (f_get_WQ_w_fish.R in scripts folder)
integrated_data %>%
  mutate(year = format(date, "%Y")) %>%
  group_by(site, year) %>%
  summarise(total = sum(!is.na(date)))


# method and category are linked because data gaps less than or equal to seven consecutive days were imputed, while larger gaps were estimated by a linear regression. The remaining 498 days were previous to the installation of the Rio Vista CDEC station.

# data sources vary, daily means (daily_mean) were provided for 1998 at the Yolo Bypass and Sherwood Harbor, Yolo Bypass Fish Monitoring Program's temperature logger data was summarized in this repository (ybfmp_logger) and published data from Pien et al. 2020 (Pien_2020) and Pien and Kwan 2022 (WQ_w_fish) were also incorporated.

integrated_data %>%
  group_by(category, method) %>%
  summarise_each(funs(n = sum(!is.na(.))))

# length is the number of consecutive days of missing data that was imputed or predicted 
plot_data <- integrated_data %>%
  mutate(year = format(date, "%Y")) %>%
  group_by(region, year) %>%
  summarise(mean = mean(length, na.rm = TRUE), max = max(length, na.rm = TRUE), min = min(length, na.rm = TRUE))

region <- c("floodplain_bypass", "river_downstream", "river_upstream")
color <- c("#3cb44b", "#911eb4", "#000075")

col <- data.frame(region, color)
plot_data <- merge(plot_data, col, by ="region")

plot(plot_data$year, plot_data$max, 
     col = plot_data$color,
     cex = 1.5, 
     pch = 16,
     xlab = "Year",
     ylab = "Max length",
     main = "Max consecutive missing dates per Year")
legend("topright", c("river_upstream", "floodplain_bypass", "river_downstream"), col = c("#000075", "#3cb44b", "#911eb4"), pch = 16)

```


```{r qc plots, echo=FALSE}

integrated_data <- within(integrated_data, year <- format(integrated_data$date, "%Y"))

for(i in unique(integrated_data$year)){

    temp_dat <- integrated_data[integrated_data$year == i,]

    #mypath <- file.path("qc/", file.name = paste("qc_plot_", i, ".png", sep = ""))
    #png(file = mypath, width = 960, height = 480)

    plot(temp_dat$date, temp_dat$mean,
         col = ifelse(temp_dat$region == "river_downstream",'#469990', ifelse(temp_dat$region == "river_upstream", '#f032e6', '#BABABA')), pch = 2, xlab = "Date", ylab = "", yaxt="n", ylim = c(0,30))
    
    legend("topright", c(paste("Year", i, sep = " "), "river_downstream", "river_upstream", "floodplain_bypass", "mean", "max", "min"), pch = c(15, 15, 15, 15, 2, 1, 5), col = c('#FFFFFF', '#469990', '#f032e6', '#BABABA', '#404040', '#404040', '#404040'), bty ="n")

    par(new = TRUE)

    plot(temp_dat$date, temp_dat$max,
         col = ifelse(temp_dat$region == "river_downstream",'#469990', ifelse(temp_dat$region == "river_upstream", '#f032e6', '#BABABA')), pch = 1, xlab = "Date", ylab = "", yaxt="n", ylim = c(0,30))
    
    par(new = TRUE)

    plot(temp_dat$date, temp_dat$min,
         col = ifelse(temp_dat$region == "river_downstream",'#469990', ifelse(temp_dat$region == "river_upstream", '#f032e6', '#BABABA')), pch = 5, xlab = "Date", ylab = "Temperature (°C)", ylim = c(0,30))

    #dev.off()

    par(new = FALSE)
}

# 2013 loosk wrong
colnames(lis)[2] <- "date"
lis$region <- "lis"
integrated_data_v2 <- rbind(rv, shw, yb, lis)

integrated_data_v2$date <- as.Date(integrated_data_v2$date)
integrated_data_v2 <- within(integrated_data_v2, year <- format(integrated_data_v2$date, "%Y"))

dat_2013 <- subset(integrated_data_v2, year =="2013")
unique(dat_2013$method)

method <- c("Pien_2020", "ybfmp_logger", "imputeTS", "WQ_w_fish")
pch <- c(0, 2, 1, 6)

pch_dat <- data.frame(method, pch)

dat_2013 <- merge(dat_2013, pch_dat, by = "method")

plot(dat_2013$date, dat_2013$min,
         col = ifelse(dat_2013$region == "river_downstream",'#469990', 
                      ifelse(dat_2013$region == "river_upstream", '#f032e6', ifelse(dat_2013$region == "floodplain_bypass", '#BABABA', '#404040' ))), pch = dat_2013$pch, xlab = "Date", ylab = "Temperature (°C)", ylim = c(0,30))

```

